#  服务部署  
##  运行镜像  
　　在确认`oc new-app`执行符合预期后为了确认应用在datafoundry平台上发布的情况，首先执行在datafoundry平台执行频率最高的命令  
```  
$ oc get pods   
```   
　　这里出现了一个datafoundry平台中最最重要的一个基本要素POD，它是平台调度的最小单元，它是由一个或多个容器组成的集合。   
通过执行上述命令，我们可以看到类似如下信息 
  
```  
NAME                  READY     STATUS      RESTARTS   AGE
docker-2048-1-build   0/1       Running     0          1m   
```      

可以看到已经有一个pod在运行，我们可以通过如下命令查看pod的执行情况   

```   
$  oc describe pods docker-2048-1-build 
```  

通过上述命令可以看到pods的基本信息，包括pods执行的节点，pods初始化过程中的信息，进一步我们可以使用如下命令  

```  
$  oc logs docker-2048-1-build  
```  
上述命令讲显示pod中应用在执行过程中输出到标准输出和标准错误中的信息，当输出信息显示为如下内容时说明镜像构建已经完成  

```  
push sussessed  
```  
我们再通过`oc get pods` 命令来查看必要的信息，输入内容如下:  

```  
docker-2048-1-build   POD     complete  
docker-2048-1-deploy  POD     running  
docker-2048-1-abcxyz  POD     containercreate  
```  
或者也有可能为  

```  
docker-2048-1-build   POD     complete  
docker-2048-1-deploy  POD     containercreate  
```  
以上描述的都是正常构建镜像情况的结果，假如在镜像构建过程中输出的信息为异常终端，或者pod的状态不为complete，需要通过`oc logs`和`oc describe`命令从如下几个方面进行排查: 
 
*  构建任务启动失败  
  *  POD资源配额已用完，build任务也是通过启动相应POD来完成，如果POD的配置已经达到上线将无法启动构建任务  
  *  调度构建任务POD失败，关于POD调度失败的问题详见相关专题  
  *  拉取构建任务镜像失败，在datafoundry平台中镜像构建任务是由一类系统基础镜像启动成POD后完成，如果构建基础镜像拉取失败，将无法启动构建任务。  
* 镜像构建失败  
  * 容器构建Dockerfile不正确，如果Dockerfile不正确容器将不能构建成功，因此需要保证Dockerfile经过严格测试，dockerfile中的关键信息发生变化是要及时更新，例如tomcat在Apache网站上的下载地址  
  * 构建过程中无法访问远程资源，例如要现在的软件包，要更新的系统功能，这多是由于镜像中系统更新或者软件下载的源默认为国外地址，在国内访问时存在较多限制导致，当然也可能由于系统的相关网络功能异常导致，随着系统的不断稳定这类问题出现的机率已相对较小，因此当镜像构建过程中出现网络方面问题时可以先排除是否为国内无法访问国外网络地址，如果是在访问国外网络地址不受限制或国内网络地址出现异常时先排除对端服务是否正常，如对端服务正常才考虑平台网络问题，系统管理员处理此类问题的方法和流程详见网络问题处理专题介绍  
  * 私有git仓库的登录的鉴权信息配置错误，可参考buildconfig专题介绍中私有git仓库登录鉴权信息配置过程进行检查  
  * 镜像构建所需计算、内存资源超出平台所分配资源，这多是针对镜像构建中执行的从源代码build执行程序的过程，表示构建任务相对复杂或者构建任务配置不正确导致在构建过程中消耗了过多的系统资源。  
* 镜像上传失败  
  * 镜像构建正常但镜像上传失败，这类问题多是由平台内置镜像仓库异常导致，可尝试通过`oc start-build buildconfigname`来重新构建，以及删除bc、is后通过`oc new-build   https://github.com/***`来重新启动创建及启动构建任务，如持续失败或异常可与系统管理员联系。系统管理员处理此类问题的方法和流程详见镜像仓库问题处理专题介绍  
  * 还有一种相少见的情况为节点到内部镜像仓库网络异常导致，这是构建任务还在建立与平台内容镜像仓库的网络连接，如果此时构建任务失败多提示“no route to host”或者“50X”网关错误，开发者遇到此类问题可以在尝试按照上述镜像上传失败案例中提供的`oc start-build`以及`oc new-build`命令尝试重新构建，如不能解决可与系统管理源联系，系统管理员可参考平台网络相关检查和处理流程进行处理，详见具体专题。  

### 镜像部署入门  
上面一节我们讨论镜像构建和经常会在镜像构建过程中遇到的问题和处理方式，本节我们来看一下2048游戏的部署过程。依然是从最长用的`oc get pods`命令，开始通过执行该命令我们可以看到在目前系统已经完成的build任务和正在执行的deploy任务  

```    
docker-2048-1-build   POD     complete  
docker-2048-1-deploy  POD     running  
docker-2048-1-abcxyz  POD     containercreate  
``` 
从命令显示结果可以看出平台是通过一个部署任务POD来启动应用容器，一个POD的启动过程会经过调度，创建、启动、运行几个阶段。通常在平台内部构建的应用部署会很快。但是也会遇到一些问题，有些是平台安全策略导致应用不能获取所需的高级别系统权限，例如fork进程、root执行、使用主机端口等，有些是由于平台信息发生变化而部署任务未能及时更新或者填写错误导致，我们可以通过`oc get pods`来获得应用启动的状态，通常会遇到如下的异常信息

*  ImgPullBackOff  
   如果应用容器启动状态为`ImgPullBackoff`则说明平台无法从镜像仓库中拉取应用镜像，如果是从平台内置镜像仓库拉取应用镜像可以通过`oc get is`命令查看当前应用镜像的仓库地址信息，如果是从平台外镜像仓库中拉取镜像也需要再次确认镜像仓库地址是否正确。
*  CrashLoopBackOff
如果应用容器启动状态为`CrashLoopBackOff`则说明容器中得应用没有正常启动，导致这种情况的原因主要包括如下几个方面：  
	*  容器中应用启动方式不对，由于在容器中除非特殊需要通常是没有进程管理功能的，这也就是说容器中的应用不能以后台进程方式运行，子进程终止后容器也会终止，这些在应用适配容器以及Dockerfile编写时要格外注意，同时这些错误可以在容器构建完成后在Docker运行一下就可以很快发现  
	*  应用依赖的其他服务或者组件没有启动或者无法连接，可以通过`oc logs `命令检查应用日志
	*  容器中应用的启动用户不满足平台安全要求，为了安全考虑通常平台是不会允许以容器中的root用户来启动容器中的应用，而是会限制用户id在100以上的用户来启动应用，而这需要通过在Dockerfile中用user关键词来显示声明，例如
	
	  ```  
	  FROM baseimage
	  user root
	  RUN update_some_system_package
	  
	  user 200
	  RUN build_some_application
	  
	  CMD start_application.sh
	  ```  
	* 平台在安全上的考虑除了容器中应用的启动用户设置外，还会对容器中应用启动后的一些系统级的操作进行限制，例如fork、kill等。   	 

### 内部服务入门  
在完成了镜像构建和部署之后，我们就可以通过内部服务将已经部署的服务开放给平台中的其他应用来使用了。内部服务在平台中叫`service`，它是平台中的重要基础要素，可以通过`oc get service`命令经行查看。  

### 外部服务入门  
在应用开放给平台内部使用的同时，应用还可以开放给平台外部使用，将能力对外开放的功能叫`route`,它也是平台的基础要素之一，可以通过`oc expose svc`命令来实现。例如，将2048应用开放对外使用的命令为：  

```  
oc expose svc docker-2048  
```   

通过`oc get route`命令可以查看route的记录，有了route就可以在浏览器中使用2048游戏了。 